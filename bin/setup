#!/usr/bin/env ruby
require_relative '../lib/manageiq/environment'
require 'optparse'

options = {:do_tests => true, :do_db => true}
OptionParser.new do |opts|
  opts.banner = "Usage: setup [options]"
  opts.on("-d", "--no-db", "Do not prepare db") do
    options[:do_db] = false
  end
  opts.on("-t", "--no-tests", "Do not perform tests") do
    options[:do_tests] = false
  end
  opts.on("-h", "--help", "Displays this help") do
    puts opts
    exit
  end
end.parse!

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

chdir Environment::APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file.
  Environment.ensure_config_files

  puts '== Installing dependencies =='
  Environment.while_updating_bower do
    Environment.install_bundler
    Environment.bundle_install

    if options[:do_db]
      # Note, we deviate from the default rails db:setup here because
      # it invokes the db:setup rake task which creates the db from the
      # schema (and seeds it), but doesn't run through migrations.
      Environment.create_database
      Environment.migrate_database
      Environment.seed_database
    end

    Environment.setup_test_environment if options[:do_tests]
  end
  Environment.clear_logs_and_temp
end
