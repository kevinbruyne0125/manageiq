#!/usr/bin/env ruby

require File.expand_path("../../../config/environment", __dir__)

ems_id = ENV["EMS_ID"]

ems      = ExtManagementSystem.find(ems_id)
all_emss = [ems] + ems.child_managers
ems_opts = all_emss.map do |e|
  e.attributes.merge(
    "endpoints"       => e.endpoints,
    "authentications" => e.authentications
  )
end

provider_opts = {
  :ems       => ems_opts,
  :messaging => MiqQueue.messaging_client_options
}

# Create a temp file and immediately unlink it to create a
# secure hidden file to be used for the child process' stdin.
stdin_tmp = Tempfile.new
File.unlink(stdin_tmp.path)

stdin_tmp.write(provider_opts.to_json)
stdin_tmp.rewind

$stdin.reopen(stdin_tmp)

Kernel.exec(ARGV.shelljoin)
